(function(){
  function Joystick(opts){
    var zone = opts.zone;
    var base = document.createElement('div');
    var stick = document.createElement('div');
    base.style.position='absolute';
    base.style.width='100px';
    base.style.height='100px';
    base.style.borderRadius='50%';
    base.style.background='rgba(255,255,255,0.3)';
    base.style.left=opts.position && opts.position.left || '0px';
    base.style.bottom=opts.position && opts.position.bottom || '0px';
    stick.style.position='absolute';
    stick.style.width='60px';
    stick.style.height='60px';
    stick.style.left='20px';
    stick.style.top='20px';
    stick.style.borderRadius='50%';
    stick.style.background=opts.color||'white';
    base.appendChild(stick);
    zone.appendChild(base);

    var active=false,startX=0,startY=0,callbacks={move:[],end:[]};
    function emit(name,data){callbacks[name].forEach(function(fn){fn({},data);});}
    base.addEventListener('pointerdown',function(e){
      active=true;startX=e.clientX;startY=e.clientY;
      e.preventDefault();
    });
    window.addEventListener('pointermove',function(e){
      if(!active) return;
      var dx=e.clientX-startX,dy=e.clientY-startY;
      var dist=Math.sqrt(dx*dx+dy*dy);
      var rad=Math.atan2(dy,dx);
      var limited=Math.min(dist,40);
      stick.style.transform='translate('+ (limited*Math.cos(rad))+'px,'+(limited*Math.sin(rad))+'px)';
      emit('move',{angle:{radian:rad}});
    });
    window.addEventListener('pointerup',function(){
      if(active){
        active=false;
        stick.style.transform='translate(0,0)';
        emit('end');
      }
    });
    this.on=function(name,fn){if(callbacks[name])callbacks[name].push(fn);};
    this.remove=function(){zone.removeChild(base);};
  }

  window.nipplejs={create:function(opts){return new Joystick(opts);}};
})();

